<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bảng tính hạng mục (có Tổng m²)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#0f1731;--panel2:#111c3a;
      --text:#e9edff;--muted:#aab3d6;--line:rgba(255,255,255,.10);
      --good:#3ddc97;--warn:#ffd166;--bad:#ff6b6b;--accent:#00c2ff;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -20%, rgba(0,194,255,.18), transparent 55%),
      radial-gradient(1000px 700px at 120% 10%, rgba(153,102,255,.18), transparent 55%),
      var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(10px);
      background:rgba(11,16,32,.65);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:99px;background:linear-gradient(135deg,var(--accent),#9966ff)}
    .brand h1{font-size:16px;margin:0}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;user-select:none;
      transition:transform .08s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      font-weight:600;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(0,194,255,.35)}
    .btn.danger{border-color:rgba(255,107,107,.35)}
    main{max-width:1200px;margin:0 auto;padding:18px 16px 36px}
    .grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .hd{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .card .bd{padding:14px}
    .muted{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);font-weight:700;text-align:left;padding:0 10px}
    td{padding:10px 10px;background:rgba(255,255,255,.06);border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
    tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:14px;border-bottom-right-radius:14px}
    input, select, textarea{
      width:100%;
      background:rgba(6,10,20,.35);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(0,194,255,.55)}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .sum{
      display:flex;flex-direction:column;gap:10px
    }
    .sum-row{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:12px 12px;border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
    }
    .sum-row .label{color:var(--muted);font-size:12px}
    .sum-row .value{font-weight:800;font-variant-numeric:tabular-nums}
    .sum-row.good{border-color:rgba(61,220,151,.35)}
    .sum-row.warn{border-color:rgba(255,209,102,.35)}
    .sum-row.accent{border-color:rgba(0,194,255,.35)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-size:12px;color:var(--muted)
    }
    .right-col .bd{display:flex;flex-direction:column;gap:12px}
    textarea{min-height:220px;resize:vertical}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.65);color:#fff;border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;border-radius:14px;backdrop-filter:blur(10px);
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
      opacity:0;pointer-events:none;transition:opacity .2s ease, transform .2s ease;
      font-size:13px
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    footer{max-width:1200px;margin:0 auto;padding:16px;color:var(--muted);font-size:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;border:1px solid var(--line);border-bottom-color:rgba(255,255,255,.22);padding:2px 6px;border-radius:8px;background:rgba(255,255,255,.05)}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Bảng tính hạng mục</h1>
          <div class="sub">Tự cộng tiền + tự cộng <b>Tổng m²</b> cho các hạng mục có ĐVT là m2/m²</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnAddRow">+ Thêm hạng mục</button>
        <button class="btn danger" id="btnClear">Xoá hết</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <h2>Danh sách hạng mục</h2>
        <span class="pill">Mẹo: ĐVT <span class="kbd">m2</span> hoặc <span class="kbd">m²</span> sẽ được tính vào Tổng m²</span>
      </div>
      <div class="bd">
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px;">Tên hạng mục</th>
                <th style="min-width:90px;">ĐVT</th>
                <th class="num" style="min-width:100px;">Số lượng</th>
                <th class="num" style="min-width:140px;">Đơn giá</th>
                <th class="num" style="min-width:150px;">Thành tiền</th>
                <th style="min-width:70px;"></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px;">
          Đơn vị tiền: VNĐ. Bạn có thể nhập số có dấu phẩy/ chấm, hệ thống sẽ tự “lọc” và hiểu là số.
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card right-col">
      <div class="hd">
        <h2>Khung tổng</h2>
        <div class="pill" id="rowCountPill">0 hạng mục</div>
      </div>
      <div class="bd">
        <div class="sum">
          <div class="sum-row accent">
            <div class="label">Tổng m²</div>
            <div class="value" id="sumM2">0</div>
          </div>

          <div class="sum-row">
            <div class="label">Tạm tính</div>
            <div class="value" id="subTotal">0</div>
          </div>

          <div class="sum-row warn" style="flex-direction:column;align-items:stretch;">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
              <div class="label">Giảm giá / Voucher (VNĐ)</div>
              <div class="value" id="discountShow">0</div>
            </div>
            <input id="discount" class="num" inputmode="numeric" placeholder="VD: 100000" />
          </div>

          <div class="sum-row good">
            <div class="label">Tổng thanh toán</div>
            <div class="value" id="grandTotal">0</div>
          </div>
        </div>

        <div class="card" style="border-radius:16px">
          <div class="hd">
            <h2>Xuất nội dung</h2>
            <div class="actions">
              <button class="btn primary" id="btnGen">Tạo nội dung</button>
              <button class="btn" id="btnCopy">Copy (PC)</button>
              <button class="btn" id="btnCopyMobile">Copy (Điện thoại)</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="out" placeholder="Bấm “Tạo nội dung” để xuất bảng tóm tắt..."></textarea>
            <div class="muted" style="margin-top:8px;">
              Copy (Điện thoại) dùng cách chọn text + fallback để giảm lỗi khi nội dung dài.
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>
</main>

<footer>
  © Bảng tính hạng mục — bản gọn chạy 1 file HTML. (Bạn muốn nhập “đơn vị khác” cũng được, nhưng chỉ m2/m² mới được tính vào Tổng m².)
</footer>

<div class="toast" id="toast">Đã copy</div>

<script>
  // ========= Helpers =========
  const $ = (sel) => document.querySelector(sel);

  function showToast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>t.classList.remove("show"), 1400);
  }

  // Parse number: accept "1.234.567" or "1,234,567" or "1234567"
  function parseMoney(v){
    if (v == null) return 0;
    const s = String(v).trim();
    if (!s) return 0;

    // Keep digits, minus, comma, dot
    const cleaned = s.replace(/[^\d,.\-]/g, "");
    if (!cleaned) return 0;

    // Heuristic:
    // If has both comma and dot, assume thousand separators; remove both and parse.
    // Else if has comma only, treat comma as thousand separator (common VN input) => remove.
    // Else dot only => remove (thousand separator) unless looks like decimal; but VN money usually integer.
    let x = cleaned;

    const hasComma = x.includes(",");
    const hasDot = x.includes(".");

    if (hasComma && hasDot){
      x = x.replace(/[.,]/g, "");
    } else if (hasComma){
      x = x.replace(/,/g, "");
    } else if (hasDot){
      x = x.replace(/\./g, "");
    }

    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }

  function fmt(n){
    const v = Math.round(Number(n || 0));
    return v.toLocaleString("vi-VN");
  }

  function fmtM2(n){
    // show up to 2 decimals, trim trailing zeros
    const x = Math.round((Number(n || 0)) * 100) / 100;
    return (x % 1 === 0) ? String(x.toFixed(0)) : String(x.toFixed(2)).replace(/\.?0+$/,'');
  }

  function isUnitM2(unit){
    const u = String(unit || "").trim().toLowerCase();
    return u === "m2" || u === "m²";
  }

  // ========= Data + UI =========
  const defaultUnits = ["m2", "m²", "md", "m", "cái", "bộ", "tấm", "kg", "khác"];
  let items = [];

  function makeRow(item, idx){
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <input data-k="name" placeholder="VD: Trần thạch cao phòng khách" value="${escapeHtml(item.name || "")}">
      </td>
      <td>
        <select data-k="unit">
          ${defaultUnits.map(u => `<option value="${u}" ${String(item.unit||"")===u ? "selected":""}>${u}</option>`).join("")}
        </select>
        <div style="margin-top:6px; display:none" class="unit-other">
          <input data-k="unitOther" placeholder="Nhập ĐVT khác..." value="${escapeHtml(item.unitOther || "")}">
        </div>
      </td>
      <td>
        <input class="num" data-k="qty" inputmode="decimal" placeholder="VD: 12.5" value="${escapeHtml(item.qty ?? "")}">
      </td>
      <td>
        <input class="num" data-k="price" inputmode="numeric" placeholder="VD: 180000" value="${escapeHtml(item.price ?? "")}">
      </td>
      <td class="num" style="font-weight:800" data-k="amount">0</td>
      <td style="text-align:right;">
        <button class="btn danger" data-act="del" title="Xoá">Xoá</button>
      </td>
    `;

    // handle unit "khác"
    const unitSel = tr.querySelector('select[data-k="unit"]');
    const otherWrap = tr.querySelector(".unit-other");
    const otherInput = tr.querySelector('input[data-k="unitOther"]');

    function syncOther(){
      const val = unitSel.value;
      const isOther = val === "khác";
      otherWrap.style.display = isOther ? "block" : "none";
      if (!isOther) otherInput.value = "";
      recalc();
    }
    unitSel.addEventListener("change", syncOther);
    syncOther();

    // input handlers
    tr.querySelectorAll("input, select").forEach(el=>{
      el.addEventListener("input", ()=>{
        const k = el.getAttribute("data-k");
        const it = items[idx];
        if (!it) return;

        if (k === "unitOther"){
          it.unitOther = el.value;
        } else if (k === "name"){
          it.name = el.value;
        } else if (k === "unit"){
          it.unit = el.value;
        } else if (k === "qty"){
          it.qty = el.value;
        } else if (k === "price"){
          it.price = el.value;
        }
        recalc();
      });
    });

    // delete
    tr.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      items.splice(idx, 1);
      render();
      recalc();
    });

    return tr;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function render(){
    const tb = $("#rows");
    tb.innerHTML = "";
    items.forEach((it, idx)=> tb.appendChild(makeRow(it, idx)));
    $("#rowCountPill").textContent = `${items.length} hạng mục`;
  }

  function calc(){
    let sub = 0;
    let totalM2 = 0;

    // update each row amount cell
    const rows = Array.from($("#rows").children);

    items.forEach((it, i)=>{
      const qty = Number(String(it.qty ?? "").replace(",", "."));
      const q = Number.isFinite(qty) ? qty : 0;

      const unit = (it.unit === "khác") ? (it.unitOther || "").trim() : (it.unit || "");
      const price = parseMoney(it.price);

      const amount = q * price;
      sub += amount;

      if (isUnitM2(unit)) totalM2 += q;

      const row = rows[i];
      if (row){
        const amtCell = row.querySelector('[data-k="amount"]');
        if (amtCell) amtCell.textContent = fmt(amount);
      }
    });

    const discount = parseMoney($("#discount").value);
    const grand = Math.max(0, sub - discount);

    return { sub, discount, grand, totalM2 };
  }

  function recalc(){
    const { sub, discount, grand, totalM2 } = calc();
    $("#sumM2").textContent = fmtM2(totalM2);
    $("#subTotal").textContent = fmt(sub);
    $("#discountShow").textContent = fmt(discount);
    $("#grandTotal").textContent = fmt(grand);
  }

  // ========= Export =========
  function buildExportText(){
    const { sub, discount, grand, totalM2 } = calc();
    const lines = [];
    lines.push("BẢNG TÓM TẮT HẠNG MỤC");
    lines.push("—".repeat(28));
    items.forEach((it, idx)=>{
      const name = (it.name || "").trim() || `(Hạng mục ${idx+1})`;
      const qty = Number(String(it.qty ?? "").replace(",", "."));
      const q = Number.isFinite(qty) ? qty : 0;

      const unit = (it.unit === "khác") ? (it.unitOther || "").trim() : (it.unit || "");
      const price = parseMoney(it.price);
      const amount = q * price;

      lines.push(`${idx+1}. ${name}`);
      lines.push(`   SL: ${fmtM2(q)} ${unit || "(chưa có ĐVT)"}  |  ĐG: ${fmt(price)}  |  TT: ${fmt(amount)}`);
    });
    lines.push("—".repeat(28));
    lines.push(`Tổng m²: ${fmtM2(totalM2)} m²`);
    lines.push(`Tạm tính: ${fmt(sub)} VNĐ`);
    lines.push(`Giảm giá: ${fmt(discount)} VNĐ`);
    lines.push(`Tổng thanh toán: ${fmt(grand)} VNĐ`);
    return lines.join("\n");
  }

  async function copyTextSmart(text){
    // Try Clipboard API first
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      return false;
    }
  }

  function fallbackSelectAndCopy(textarea){
    textarea.focus();
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    try{
      const ok = document.execCommand("copy");
      return ok;
    }catch(e){
      return false;
    }
  }

  // ========= Events =========
  $("#btnAddRow").addEventListener("click", ()=>{
    items.push({ name:"", unit:"m2", qty:"", price:"" });
    render();
    recalc();
  });

  $("#btnClear").addEventListener("click", ()=>{
    items = [];
    render();
    recalc();
    $("#out").value = "";
    showToast("Đã xoá hết");
  });

  $("#discount").addEventListener("input", recalc);

  $("#btnGen").addEventListener("click", ()=>{
    $("#out").value = buildExportText();
    showToast("Đã tạo nội dung");
  });

  $("#btnCopy").addEventListener("click", async ()=>{
    const out = $("#out");
    const text = out.value.trim();
    if (!text){ showToast("Chưa có nội dung để copy"); return; }

    const ok = await copyTextSmart(text);
    if (ok) showToast("Đã copy");
    else {
      const ok2 = fallbackSelectAndCopy(out);
      showToast(ok2 ? "Đã copy (fallback)" : "Copy thất bại");
    }
  });

  $("#btnCopyMobile").addEventListener("click", async ()=>{
    const out = $("#out");
    const text = out.value.trim();
    if (!text){ showToast("Chưa có nội dung để copy"); return; }

    // Mobile-friendly: ensure generated, then try clipboard, fallback selection
    const ok = await copyTextSmart(text);
    if (ok) { showToast("Đã copy (mobile)"); return; }

    const ok2 = fallbackSelectAndCopy(out);
    showToast(ok2 ? "Đã copy (mobile fallback)" : "Copy thất bại");
  });

  // ========= Init =========
  items = [
    { name:"Trần thạch cao phòng khách", unit:"m2", qty:"18.5", price:"180000" },
    { name:"Sơn nước", unit:"m2", qty:"52", price:"25000" },
    { name:"Đèn downlight", unit:"cái", qty:"10", price:"45000" }
  ];
  render();
  recalc();
</script>
</body>
</html>
