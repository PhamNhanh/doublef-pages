<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£ng t√≠nh ti·ªÅn th·∫°ch cao (nhi·ªÅu nh√≥m - xu·∫•t b·∫£ng thanh to√°n)</title>

  <style>
    :root{
      /* LIGHT + BLUE */
      --bg0:#f5fbff;
      --bg1:#eef7ff;
      --card:#ffffff;
      --card2: rgba(255,255,255,.75);
      --text:#0b1220;
      --muted:#4b607a;
      --muted2:#6e86a6;
      --line: rgba(12, 74, 110, .14);
      --line2: rgba(12, 74, 110, .10);

      --primary:#0284c7; /* sky-600 */
      --primary2:#0ea5e9; /* sky-500 */
      --primary3:#38bdf8; /* sky-400 */
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;

      --shadow: 0 18px 60px rgba(2, 132, 199, .14);
      --shadow2: 0 10px 30px rgba(2, 132, 199, .10);
      --radius: 16px;
      --radius2: 20px;

      --focus: 0 0 0 4px rgba(14,165,233,.22);
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 20% -10%, rgba(56,189,248,.24), transparent 60%),
        radial-gradient(1000px 650px at 110% 10%, rgba(2,132,199,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    /* Subtle animated blobs */
    .bgfx{
      position:fixed; inset:-150px -150px auto auto;
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(14,165,233,.35), transparent 60%),
                  radial-gradient(circle at 70% 70%, rgba(56,189,248,.25), transparent 58%);
      filter: blur(24px);
      opacity:.55;
      pointer-events:none;
      animation: floaty 9s ease-in-out infinite;
      z-index:0;
    }
    .bgfx2{
      position:fixed; inset:auto auto -160px -160px;
      width:520px; height:520px;
      background: radial-gradient(circle at 30% 30%, rgba(2,132,199,.22), transparent 62%),
                  radial-gradient(circle at 70% 70%, rgba(56,189,248,.20), transparent 60%);
      filter: blur(26px);
      opacity:.55;
      pointer-events:none;
      animation: floaty2 11s ease-in-out infinite;
      z-index:0;
    }
    @keyframes floaty{
      0%,100%{transform: translate(0,0) scale(1)}
      50%{transform: translate(-22px, 14px) scale(1.03)}
    }
    @keyframes floaty2{
      0%,100%{transform: translate(0,0) scale(1)}
      50%{transform: translate(18px, -18px) scale(1.02)}
    }

    header, main, .project-toolbar{position:relative; z-index:1}
    header, main{max-width:1220px;margin:0 auto;padding:18px}
    header{padding-top:22px}

    /* Topbar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:260px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary3));
      box-shadow: 0 10px 26px rgba(2,132,199,.25);
      display:grid; place-items:center;
      flex:none;
      transform: translateZ(0);
    }
    .logo svg{filter: drop-shadow(0 6px 16px rgba(2,132,199,.18))}
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{margin:3px 0 0; color:var(--muted); font-size:13px; line-height:1.45}

    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.8);
      color: var(--muted);
      font-size:12px;
      box-shadow: 0 6px 18px rgba(2,132,199,.08);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .chip:hover{transform: translateY(-1px); box-shadow: 0 10px 26px rgba(2,132,199,.12)}
    .dot{width:10px; height:10px; border-radius:999px; background: var(--primary2); box-shadow: 0 0 0 4px rgba(14,165,233,.18)}
    .tag{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line2);
      background: rgba(2,132,199,.08);
      color: #084c7a;
      font-weight:700;
    }

    /* Layout grid */
    .grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(255,255,255,.78));
      box-shadow: var(--shadow2);
      margin-top:14px;
      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{
      box-shadow: var(--shadow);
      border-color: rgba(2,132,199,.22);
      transform: translateY(-1px);
    }
    .hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line2);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(2,132,199,.07), rgba(255,255,255,.0));
    }
    .title{font-weight:900; font-size:13px; letter-spacing:.3px; color:#083e63}

    .bd{padding:12px}

    /* Inputs */
    button,input,select,textarea{font:inherit; color:inherit}
    input,select,textarea{
      width:100%;
      border:1px solid rgba(2,132,199,.18);
      background: rgba(255,255,255,.92);
      padding:10px 10px;
      border-radius:14px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease, background .18s ease;
      box-shadow: 0 8px 20px rgba(2,132,199,.06);
    }
    input:focus,select:focus,textarea:focus{box-shadow: var(--focus), 0 12px 30px rgba(2,132,199,.10); border-color: rgba(2,132,199,.35)}
    textarea{min-height:96px; resize:vertical}

    button{
      border:1px solid rgba(2,132,199,.20);
      background: rgba(255,255,255,.86);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(2,132,199,.08);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
    }
    button:hover{background: rgba(2,132,199,.06); border-color: rgba(2,132,199,.32); transform: translateY(-1px); box-shadow: 0 14px 30px rgba(2,132,199,.12)}
    button:active{transform: translateY(0px); box-shadow: 0 8px 18px rgba(2,132,199,.10)}
    .primary{
      border-color: rgba(2,132,199,.32);
      background: linear-gradient(135deg, rgba(2,132,199,.18), rgba(56,189,248,.18));
    }
    .danger{
      border-color: rgba(220,38,38,.30);
      background: linear-gradient(135deg, rgba(220,38,38,.10), rgba(245,158,11,.06));
    }
    .ghost{
      border-color: rgba(2,132,199,.10);
      background: rgba(255,255,255,.65);
      color: #0b3050;
    }

    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:700}

    /* Pills */
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.82);
      color:var(--muted);
      font-size:13px;
      box-shadow: 0 10px 22px rgba(2,132,199,.08);
    }
    .pill b{color:var(--text)}
    .note{color:var(--muted); font-size:12px; line-height:1.55; margin-top:10px}

    .hr{height:1px;background:rgba(2,132,199,.16);margin:12px 0}

    .ok{color:var(--good)} .bad{color:var(--bad)}

    /* Table */
    table{width:100%; border-collapse:collapse}
    th,td{border-top:1px solid rgba(2,132,199,.14); padding:9px; font-size:13px; vertical-align:middle}
    th{
      color:#285b7f;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.6px;
      background: rgba(2,132,199,.06);
      border-top:none;
    }
    .num{text-align:right}
    .center{text-align:center}
    .mini{width:180px}
    .mini2{width:140px}
    .mini3{width:120px}

    /* Groups */
    .group{
      border:1px solid rgba(2,132,199,.16);
      border-radius: var(--radius2);
      overflow:hidden;
      margin-bottom:12px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 14px 30px rgba(2,132,199,.08);
      animation: pop .25s ease both;
    }
    @keyframes pop{
      from{opacity:.0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }
    .group-hd{
      padding:10px;
      border-bottom:1px solid rgba(2,132,199,.14);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(2,132,199,.08), rgba(255,255,255,.0));
    }
    .group-hd .left,.group-hd .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .group-body{transition: max-height .28s ease, opacity .22s ease}
    .group.collapsed .group-body{
      max-height:0 !important;
      overflow:hidden;
      opacity:0;
      border-top:0;
    }
    .group.collapsed .group-hd{border-bottom:0}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(2,132,199,.18);
      background: rgba(255,255,255,.9);
      color:#0b3a60;
    }

    /* Right side extra content */
    .hero{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      padding:12px;
      border:1px dashed rgba(2,132,199,.20);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.84);
      box-shadow: 0 12px 30px rgba(2,132,199,.08);
    }
    .hero .pic{
      width:108px; height:108px; border-radius:22px; flex:none;
      background: linear-gradient(135deg, rgba(2,132,199,.16), rgba(56,189,248,.18));
      display:grid; place-items:center;
      box-shadow: 0 18px 40px rgba(2,132,199,.12);
      overflow:hidden;
    }
    .hero .pic svg{width:90px; height:90px; opacity:.95}
    .hero .txt{min-width:220px; flex:1}
    .hero .txt .h{font-weight:900; margin:0 0 4px; color:#083e63}
    .hero .txt .p{margin:0; color:var(--muted); font-size:12.5px; line-height:1.5}
    .mini-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    /* Progress bar just for ‚Äúfeel‚Äù (UI only) */
    .bar{
      height:10px; border-radius:999px; overflow:hidden;
      border:1px solid rgba(2,132,199,.18);
      background: rgba(2,132,199,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary2), var(--primary3));
      border-radius:999px;
      transition: width .25s ease;
    }

    /* Invoice modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2, 6, 23, .45);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index: 9999;
      backdrop-filter: blur(8px);
    }
    .modal.show{display:flex}

    .modal-card{
      width:min(980px, 100%);
      height:min(92vh, 980px);
      background:#ffffff;
      color:#111;
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: 0 22px 80px rgba(2, 132, 199, .22);
      border:1px solid rgba(2,132,199,.18);
      display:flex; flex-direction:column;
    }
    .modal-hd{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(2,132,199,.08), rgba(255,255,255,.92));
      border-bottom:1px solid rgba(2,132,199,.16);
      color:#0b1220;
    }
    .modal-hd .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .modal-hd .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn-light{
      border:1px solid rgba(2,132,199,.18);
      background: rgba(255,255,255,.92);
      color:#0b1220
    }
    .btn-light:hover{background: rgba(2,132,199,.06)}

    .invoice-wrap{
      padding:18px 18px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1;
      background: #fff;
    }

    .modal-actions{
      position:sticky; bottom:0; z-index:6;
      display:none;
      gap:8px;
      padding:10px 12px;
      background: rgba(255,255,255,.90);
      border-top:1px solid rgba(2,132,199,.16);
      backdrop-filter: blur(8px);
    }
    .modal-actions button{flex:1; padding:10px 12px}

    @media(max-width:720px){
      .modal-actions{display:flex}
      .modal-hd .right{display:none}
    }
    #copyMobileBtn, #copyMobileBtn2 { display:none; }
    @media(max-width:720px){
      #copyMobileBtn, #copyMobileBtn2 { display:inline-block; }
    }

    /* Invoice styles */
    .inv-top{display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:8px;}
    .inv-meta{font-size:12px; color:#1f3850}
    .inv-title{text-align:center; margin:6px 0 10px; font-weight:900; font-size:18px; letter-spacing:.3px;}
    .inv-sub{text-align:center; font-size:12px; color:#1f3850; margin-top:-6px;}
    .inv-box{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      border:1px solid rgba(2,132,199,.18); border-radius:14px; padding:10px;
      font-size:12px; margin:12px 0;
      background: rgba(2,132,199,.04);
    }
    @media(max-width:720px){ .inv-box{grid-template-columns:1fr} }
    .inv-box b{color:#0b1220}
    .inv-table{
      width:100%; border-collapse:collapse; font-size:12px;
      border:1px solid rgba(2,132,199,.18); border-radius:14px; overflow:hidden;
    }
    .inv-table th, .inv-table td{border-top:1px solid rgba(2,132,199,.14); padding:8px; vertical-align:top}
    .inv-table th{
      background: rgba(2,132,199,.08);
      color:#0b1220; text-transform:uppercase; letter-spacing:.6px; font-size:11px;
      border-top:none;
    }
    .inv-muted{color:#355a78}
    .inv-right{text-align:right}
    .inv-center{text-align:center}
    .inv-total{
      margin-top:12px;
      border:1px solid rgba(2,132,199,.18);
      border-radius:14px;
      overflow:hidden;
    }
    .inv-total .row{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px; font-size:12px; border-top:1px solid rgba(2,132,199,.14);
      background: rgba(255,255,255,.9);
    }
    .inv-total .row:first-child{border-top:none}
    .inv-total .row b{font-size:13px}
    .inv-total .grand{background: rgba(2,132,199,.08)}
    .print-note{font-size:11px;color:#355a78;margin-top:8px;text-align:center}

    /* Force invoice black text + negative red */
    #invoiceContent,
    #invoiceContent *{
      color:#000 !important;
      opacity:1 !important;
      -webkit-text-fill-color:#000 !important;
      text-shadow:none !important;
      filter:none !important;
    }
    #invoiceContent .neg,
    #invoiceContent .neg *{
      color:#d10000 !important;
      -webkit-text-fill-color:#d10000 !important;
      font-weight:800 !important;
    }

    /* Print invoice only */
    @media print{
      body{background:#fff}
      header, main, .modal-hd, .project-toolbar, .modal-actions, .bgfx, .bgfx2{display:none !important}
      .modal{position:static; inset:auto; background:transparent; padding:0; display:block !important}
      .modal-card{box-shadow:none; border:none; border-radius:0; height:auto}
      .invoice-wrap{padding:0; overflow:visible}
      .print-note{display:none}
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(2,132,199,.18);
      box-shadow: 0 18px 60px rgba(2,132,199,.16);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      color: #0b1220;
      display:none;
      align-items:center;
      gap:10px;
      z-index: 99999;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:flex; animation: toastIn .22s ease both}
    @keyframes toastIn{
      from{opacity:0; transform: translateX(-50%) translateY(10px)}
      to{opacity:1; transform: translateX(-50%) translateY(0)}
    }
    .toast .ticon{
      width:22px; height:22px; border-radius:999px;
      background: rgba(2,132,199,.10);
      display:grid; place-items:center;
      border:1px solid rgba(2,132,199,.18);
    }

    /* Floating button */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 99998;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .fab button{
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(255,255,255,.92);
    }

    /* ============================
       ‚úÖ NEW: FORCE MOBILE MODE
       - B·∫≠t/t·∫Øt th·ªß c√¥ng b·∫±ng class .force-mobile tr√™n body
       - √âp layout gi·ªëng @media(max-width:720px)
       ============================ */
    body.force-mobile header,
    body.force-mobile main{
      padding: 12px;
      max-width: 760px;
    }
    body.force-mobile .topbar{
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    body.force-mobile .brand{min-width: unset; width: 100%;}
    body.force-mobile .chips{justify-content:flex-start}
    body.force-mobile .grid{grid-template-columns: 1fr !important;}
    body.force-mobile .project-toolbar{padding:0 12px 10px}
    body.force-mobile .mini-actions{gap:6px}
    body.force-mobile .hero .pic{width:92px; height:92px; border-radius:18px}
    body.force-mobile .hero .txt{min-width: unset}
    body.force-mobile .group-hd .left input.mini{width: 100%;}
    body.force-mobile .mini, body.force-mobile .mini2, body.force-mobile .mini3{
      width: 100% !important;
      min-width: 0 !important;
    }
    body.force-mobile .group-hd .left,
    body.force-mobile .group-hd .right{
      width:100%;
      justify-content: flex-start;
    }
    body.force-mobile table{font-size:12px}
    body.force-mobile th, body.force-mobile td{padding:8px}
    body.force-mobile .modal-actions{display:flex}
    body.force-mobile .modal-hd .right{display:none}
    body.force-mobile #copyMobileBtn, body.force-mobile #copyMobileBtn2 { display:inline-block; }
    body.force-mobile .fab{right:12px; bottom:12px}
  </style>
</head>

<body>
  <div class="bgfx"></div>
  <div class="bgfx2"></div>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" width="22" height="22" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2.8c4.9 0 8.9 4 8.9 8.9 0 4.9-4 8.9-8.9 8.9-4.9 0-8.9-4-8.9-8.9C3.1 6.8 7.1 2.8 12 2.8Z" fill="rgba(255,255,255,.95)"/>
            <path d="M7.3 13.2c1.4-3.3 7.9-3.3 9.3 0" stroke="#0284c7" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M8.2 10.2h.01M15.8 10.2h.01" stroke="#0284c7" stroke-width="3.2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>B·∫£ng t√≠nh ti·ªÅn th·∫°ch cao</h1>
          <p class="sub">
            Nhi·ªÅu nh√≥m (Tr·∫ßn/V√°ch/M·∫∑t d·ª±ng...). Nh·∫≠p theo <b>D√†i √ó R·ªông √ó H·ªá s·ªë</b>.
            T·ªïng ph·∫£i tr·∫£ = <b>T·ªïng ti·ªÅn c√°c nh√≥m ‚àí T·∫°m ·ª©ng</b>. C√≥ <b>Xu·∫•t b·∫£ng thanh to√°n</b> ƒë·ªÉ in/PDF v√† <b>Copy ·∫£nh (FULL)</b>.
          </p>
        </div>
      </div>

      <div class="chips">
        <span class="chip"><span class="dot"></span> Giao di·ªán s√°ng ‚Äì xanh</span>
        <span class="chip">M·∫πo: <span class="kbd">Esc</span> ƒë√≥ng h√≥a ƒë∆°n</span>
        <span class="chip">M·∫πo: <span class="kbd">Ctrl</span> + <span class="kbd">P</span> in/PDF</span>
        <span class="chip"><span class="tag">Ch·ªët</span> D√πng Xu·∫•t/M·ªü file d·ª± √°n ƒë·ªÉ kh√¥i ph·ª•c chu·∫©n</span>

        <!-- ‚úÖ NEW: Toggle Mobile Mode -->
        <button class="ghost" id="toggleMobileBtn" title="B·∫≠t/t·∫Øt giao di·ªán ƒëi·ªán tho·∫°i">
          üì± ƒêi·ªán tho·∫°i: <b id="mobileModeState">OFF</b>
        </button>
      </div>
    </div>
  </header>

  <!-- ===== TOOLBAR: M·ªû/XU·∫§T FILE D·ª∞ √ÅN ===== -->
  <div class="project-toolbar" style="max-width:1220px;margin:0 auto;padding:0 18px 10px">
    <div class="card" style="margin-top:14px">
      <div class="hd">
        <div class="title">Thanh c√¥ng c·ª• d·ª± √°n</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" id="btnExportProject">Xu·∫•t file d·ª± √°n</button>
          <button id="btnImportProject">M·ªü file d·ª± √°n</button>
          <button id="btnExportBackup">Xu·∫•t backup</button>
          <button id="btnPickSaveFolder">Ch·ªçn n∆°i l∆∞u m·∫∑c ƒë·ªãnh</button>
          <span class="pill" id="saveFolderHint">N∆°i l∆∞u: <b>Download</b></span>
          <button class="danger" id="btnNewProject">T·∫°o d·ª± √°n m·ªõi</button>
          <input id="projectFileInput" type="file" accept=".json,application/json" style="display:none" />
        </div>
      </div>
      <div class="bd">
        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
          <div class="note" style="margin:0">
            File d·ª± √°n l√† <b>.tcproj.json</b>. N·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ (Chrome/Edge + HTTPS/localhost) b·∫°n c√≥ th·ªÉ ch·ªçn th∆∞ m·ª•c l∆∞u m·∫∑c ƒë·ªãnh.
            <br/>Ph·ª• tr·ª£: t√¨m nhanh nh√≥m theo t√™n, thu g·ªçn/ m·ªü r·ªông nh√≥m ƒë·ªÉ thao t√°c m∆∞·ª£t h∆°n.
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap; justify-content:flex-end">
            <input id="quickSearch" placeholder="T√¨m nh√≥m (g√µ t√™n r·ªìi Enter)" style="max-width:260px" />
            <button class="ghost" id="btnExpandAll">M·ªü h·∫øt</button>
            <button class="ghost" id="btnCollapseAll">Thu g·ªçn</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <div class="title">C√°c nh√≥m thi c√¥ng</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" id="addGroup">+ Th√™m nh√≥m</button>
          <button id="saveBtn">L∆∞u</button>
          <button id="loadBtn">T·∫£i</button>
          <button class="danger" id="clearBtn">X√≥a t·∫•t c·∫£</button>
        </div>
      </div>

      <div class="bd">
        <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <span class="pill">S·ªë nh√≥m: <b id="groupCount">0</b></span>
          <span class="pill">C√¥ng th·ª©c: <b>T·ªïng nh√≥m ‚àí T·∫°m ·ª©ng</b></span>
          <span class="pill">Nh·∫≠p s·ªë: <b>3,22</b> ho·∫∑c <b>3.22</b></span>
          <span class="pill">Thu g·ªçn nh√≥m ƒë·ªÉ cu·ªôn nhanh</span>
        </div>

        <div id="groups"></div>

        <div class="note">
          <span class="tag">G·ª£i √Ω</span> N·∫øu nh√≥m kh√¥ng ph·∫£i <b>m¬≤</b> (c√°i/l·ªó/t·∫•m‚Ä¶), h·ªá th·ªëng coi c·ªôt <b>D√†i</b> l√† <b>S·ªë l∆∞·ª£ng</b>, b·ªè qua <b>R·ªông</b>.
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card" style="margin-top:14px">
        <div class="hd">
          <div class="title">T·ªïng h·ª£p & xu·∫•t b·∫£ng thanh to√°n</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="primary" id="invoiceBtn">Xu·∫•t b·∫£ng thanh to√°n</button>
          </div>
        </div>

        <div class="bd">
          <div class="hero">
            <div class="pic" aria-hidden="true">
              <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="#0ea5e9" stop-opacity=".65"/>
                    <stop offset="1" stop-color="#38bdf8" stop-opacity=".55"/>
                  </linearGradient>
                </defs>
                <rect x="16" y="20" width="88" height="70" rx="16" fill="url(#g1)" stroke="rgba(2,132,199,.35)" />
                <rect x="28" y="34" width="64" height="10" rx="6" fill="rgba(255,255,255,.75)"/>
                <rect x="28" y="52" width="50" height="10" rx="6" fill="rgba(255,255,255,.65)"/>
                <rect x="28" y="70" width="40" height="10" rx="6" fill="rgba(255,255,255,.55)"/>
                <circle cx="92" cy="76" r="12" fill="rgba(255,255,255,.85)"/>
                <path d="M88 76l3 3 6-7" stroke="#0284c7" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="txt">
              <p class="h">B·∫£ng thanh to√°n ‚Äúg·ªçn ‚Äì r√µ ‚Äì d·ªÖ ch·ªët‚Äù</p>
              <p class="p">
                Copy ·∫£nh ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p: <b>ch·ª•p FULL chi·ªÅu d√†i</b> (kh√¥ng b·ªã c·∫Øt theo khung m√†n h√¨nh).
                B·∫°n c√≥ th·ªÉ thu g·ªçn nh√≥m ƒë·ªÉ nh·∫≠p nhanh, r·ªìi m·ªü l·∫°i tr∆∞·ªõc khi xu·∫•t.
              </p>
              <div class="mini-actions">
                <span class="pill">Ph√≠m t·∫Øt: <b>Esc</b> ƒë√≥ng h√≥a ƒë∆°n</span>
                <span class="pill">M·∫πo: nh·∫≠p <b>3,22</b> ho·∫∑c <b>3.22</b></span>
              </div>
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>T·∫°m ·ª©ng (VNƒê)</label>
            <input id="advance" inputmode="numeric" placeholder="VD: 20000000" />
          </div>

          <div class="field" style="margin-top:10px">
            <label>Th√¥ng tin c√¥ng tr√¨nh</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="invDate" placeholder="Ng√†y (t·ª± l·∫•y h√¥m nay)" />
              <input id="invCustomer" placeholder="Kh√°ch h√†ng / C√¥ng tr√¨nh" />
              <input id="invAddress" placeholder="ƒê·ªãa ch·ªâ c√¥ng tr√¨nh" />
              <input id="invContact" placeholder="Li√™n h·ªá (tu·ª≥ ch·ªçn)" />
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Th√¥ng tin ng√¢n h√†ng (hi·ªÉn th·ªã tr√™n b·∫£ng thanh to√°n)</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="bankName" placeholder="T√™n ng√¢n h√†ng (VD: Vietcombank)" />
              <input id="bankBranch" placeholder="Chi nh√°nh (tu·ª≥ ch·ªçn)" />
              <input id="bankAccountName" placeholder="Ch·ªß t√†i kho·∫£n" />
              <input id="bankAccountNo" placeholder="S·ªë t√†i kho·∫£n" inputmode="numeric" />
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Ghi ch√∫ chung (hi·ªÉn th·ªã tr√™n b·∫£ng thanh to√°n)</label>
            <textarea id="globalNote" placeholder="VD: ƒê∆°n gi√° ƒë√£ bao g·ªìm v·∫≠t t∆∞... / Thanh to√°n sau nghi·ªám thu..."></textarea>
          </div>

          <div class="hr"></div>

          <div style="display:grid;gap:10px">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="color:var(--muted);font-size:13px">T·ªïng m¬≤ (c√°c nh√≥m m¬≤)</div>
              <div style="font-weight:900" id="sumM2">0</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="color:var(--muted);font-size:13px">T·ªïng ti·ªÅn c√°c nh√≥m</div>
              <div style="font-weight:900" id="sumTotal">0</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="color:var(--muted);font-size:13px">T·∫°m ·ª©ng</div>
              <div style="font-weight:900" id="sumAdvance">0</div>
            </div>

            <div class="hr"></div>

            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900;color:#083e63">C√≤n l·∫°i ph·∫£i thanh to√°n</div>
              <div style="font-weight:900;font-size:18px" id="sumRemain">0</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="color:var(--muted);font-size:13px">Tr·∫°ng th√°i</div>
              <div style="font-weight:900" id="status">‚Äî</div>
            </div>

            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="font-size:12px;color:var(--muted);font-weight:700">Thanh ‚Äúc·∫£m gi√°c ti·∫øn ƒë·ªô‚Äù</div>
                <div style="font-size:12px;color:var(--muted2)" id="kpiHint">‚Äî</div>
              </div>
              <div class="bar"><i id="kpiBar"></i></div>
            </div>
          </div>

          <div class="note">
            B·∫•m <b>Xu·∫•t b·∫£ng thanh to√°n</b> ƒë·ªÉ ra m·∫´u g·∫ßn gi·ªëng h√≥a ƒë∆°n, c√≥ b·∫£ng chi ti·∫øt + t·ªïng ti·ªÅn.
            Trong c·ª≠a s·ªï b·∫£ng thanh to√°n c√≥ n√∫t <b>Copy ·∫£nh (FULL)</b> / <b>T·∫£i ·∫£nh PNG</b> / <b>Copy (ƒëi·ªán tho·∫°i)</b>. In/PDF: b·∫•m <b>In / L∆∞u PDF</b>.
          </div>

          <div class="hr"></div>

          <div style="display:grid; gap:10px">
            <div class="pill" style="justify-content:space-between">
              <span><b>Ch·ª©c nƒÉng ph·ª•</b> (UI) ƒë√£ th√™m:</span>
              <span style="color:var(--muted2)">T√¨m nh√≥m ‚Ä¢ Thu g·ªçn ‚Ä¢ Toast</span>
            </div>
            <div class="note" style="margin:0">
              <b>Thu g·ªçn nh√≥m:</b> b·∫•m n√∫t ‚ÄúThu/M·ªü‚Äù trong m·ªói nh√≥m ƒë·ªÉ cu·ªôn nhanh h∆°n khi nh·∫≠p nhi·ªÅu d√≤ng.<br/>
              <b>T√¨m nh√≥m:</b> √¥ ‚ÄúT√¨m nh√≥m‚Äù ‚Üí g√µ t√™n ‚Üí Enter ƒë·ªÉ nh·∫£y t·ªõi nh√≥m ƒë√≥ v√† highlight.
            </div>
          </div>

        </div>
      </div>
    </div>
  </main>

  <!-- Invoice Modal -->
  <div class="modal" id="invoiceModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-hd">
        <div class="left">
          <b>Xem b·∫£ng thanh to√°n</b>
          <span class="inv-meta" id="invMetaSmall"></span>
        </div>
        <div class="right">
          <button class="btn-light" id="copyImgBtn">Copy ·∫£nh (FULL)</button>
          <button class="btn-light" id="downloadImgBtn">T·∫£i ·∫£nh PNG</button>
          <button class="btn-light" id="copyMobileBtn">Copy (ƒëi·ªán tho·∫°i)</button>
          <button class="btn-light" id="printBtn">In / L∆∞u PDF</button>
          <button class="btn-light" id="closeInvoice">ƒê√≥ng</button>
        </div>
      </div>

      <div class="invoice-wrap" id="invoiceContent"></div>

      <div class="modal-actions">
        <button class="btn-light" id="copyImgBtn2">Copy ·∫£nh (FULL)</button>
        <button class="btn-light" id="downloadImgBtn2">T·∫£i PNG</button>
        <button class="btn-light" id="copyMobileBtn2">Copy (ƒëi·ªán tho·∫°i)</button>
        <button class="btn-light" id="printBtn2">In / PDF</button>
        <button class="btn-light" id="closeInvoice2">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="ticon" aria-hidden="true">‚úì</span>
    <span id="toastText">‚Äî</span>
  </div>

  <!-- Floating actions -->
  <div class="fab" aria-hidden="false">
    <button class="ghost" id="btnTop" title="L√™n ƒë·∫ßu trang">‚Üë</button>
    <!-- ‚úÖ NEW: toggle mobile mode from floating buttons -->
    <button class="ghost" id="toggleMobileFab" title="B·∫≠t/t·∫Øt giao di·ªán ƒëi·ªán tho·∫°i">üì±</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const STORAGE_KEY = 'thachcao_payment_full_v13_filename_rule';
    const MOBILE_FORCE_KEY = 'tc_force_mobile_mode_v1';

    const fmtVND = (n) => (isFinite(n)?n:0).toLocaleString('vi-VN') + ' ‚Ç´';

    const parseNumber = (val) => {
      if (val === null || val === undefined) return 0;
      let s = String(val).trim();
      if (!s) return 0;
      s = s.replace(/[^\d.,-]/g, '');
      const hasComma = s.includes(','), hasDot = s.includes('.');
      if (hasComma && hasDot) s = s.replace(/\./g,'').replace(',', '.');
      else if (hasComma && !hasDot) s = s.replace(',', '.');
      else s = s.replace(/\.(?=\d{3}(\D|$))/g,'');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    };

    const escapeHtml = (str) => String(str ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    const unitOptions = (selected) => {
      const units = ['m¬≤','m','c√°i','l·ªó','t·∫•m','ng∆∞·ªùi','chuy·∫øn','l·∫ßn','ƒë∆°n','ho√° ƒë∆°n'];
      return units.map(u => `<option value="${u}" ${u===selected?'selected':''}>${u}</option>`).join('');
    };

    function todayVN(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    // ===== Toast =====
    let toastTimer = null;
    function toast(msg){
      const el = document.getElementById('toast');
      const tx = document.getElementById('toastText');
      if (!el || !tx) return;
      tx.textContent = msg;
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove('show'), 1800);
    }

    // =========================
    // ‚úÖ NEW: FORCE MOBILE MODE
    // =========================
    function setMobileForced(on){
      document.body.classList.toggle('force-mobile', !!on);
      localStorage.setItem(MOBILE_FORCE_KEY, on ? '1' : '0');

      const stateEl = document.getElementById('mobileModeState');
      if (stateEl) stateEl.textContent = on ? 'ON' : 'OFF';

      toast(on ? 'ƒê√£ chuy·ªÉn sang giao di·ªán ƒëi·ªán tho·∫°i' : 'ƒê√£ t·∫Øt giao di·ªán ƒëi·ªán tho·∫°i');
    }
    function toggleMobileForced(){
      const on = !document.body.classList.contains('force-mobile');
      setMobileForced(on);
    }
    function restoreMobileForced(){
      const v = localStorage.getItem(MOBILE_FORCE_KEY);
      const on = (v === '1');
      setMobileForced(on);
    }

    // ===== IME FIX =====
    let isComposing = false;
    let renderTimer = null;

    function scheduleRender(){
      if (isComposing) return;
      clearTimeout(renderTimer);
      renderTimer = setTimeout(() => render(), 60);
    }

    document.addEventListener('compositionstart', (e) => {
      const t = e.target;
      if (t && (t.matches('input') || t.matches('textarea'))) isComposing = true;
    });
    document.addEventListener('compositionend', (e) => {
      const t = e.target;
      if (t && (t.matches('input') || t.matches('textarea'))) {
        isComposing = false;
        render();
      }
    });

    let groups = [];
    const defaultGroup = () => ({
      name: 'Tr·∫ßn',
      unit: 'm¬≤',
      unitPrice: '',
      groupNote: '',
      collapsed: false,
      lines: [{ len:'', wid:'', factor: 1, note:'' }]
    });

    const groupQty = (g) => {
      const isArea = (g.unit === 'm¬≤');
      return (g.lines || []).reduce((sum, L) => {
        const len = parseNumber(L.len);
        const wid = parseNumber(L.wid);
        const fac = parseNumber(L.factor) || 1;
        return sum + (isArea ? (len*wid*fac) : (len*fac));
      }, 0);
    };
    const groupAmount = (g) => groupQty(g) * parseNumber(g.unitPrice);

    const totalM2All = () =>
      groups.reduce((s, g) => s + ((g && (g.unit === 'm¬≤' || g.unit === 'm2')) ? groupQty(g) : 0), 0);

    function getFocusKey() {
      const a = document.activeElement;
      if (!a) return null;

      if (a.matches('[data-gi][data-gk]')) {
        return { type:'group', gi:a.dataset.gi, gk:a.dataset.gk, s:a.selectionStart ?? null, e:a.selectionEnd ?? null };
      }
      if (a.matches('[data-gi][data-li][data-lk]')) {
        return { type:'line', gi:a.dataset.gi, li:a.dataset.li, lk:a.dataset.lk, s:a.selectionStart ?? null, e:a.selectionEnd ?? null };
      }
      if (a.id && ['advance','invDate','invCustomer','invAddress','invContact','globalNote','bankName','bankBranch','bankAccountName','bankAccountNo','quickSearch'].includes(a.id)) {
        return { type:'right', id:a.id, s:a.selectionStart ?? null, e:a.selectionEnd ?? null };
      }
      return null;
    }
    function restoreFocus(key) {
      if (!key) return;
      let el = null;
      if (key.type === 'group') el = document.querySelector(`[data-gi="${key.gi}"][data-gk="${key.gk}"]`);
      if (key.type === 'line')  el = document.querySelector(`[data-gi="${key.gi}"][data-li="${key.li}"][data-lk="${key.lk}"]`);
      if (key.type === 'right') el = document.getElementById(key.id);
      if (!el) return;
      el.focus({preventScroll:true});
      if (key.s !== null && key.e !== null && typeof el.setSelectionRange === 'function') {
        try { el.setSelectionRange(key.s, key.e); } catch {}
      }
    }

    function render(){
      const focusKey = getFocusKey();

      const wrap = document.getElementById('groups');
      wrap.innerHTML = '';
      document.getElementById('groupCount').textContent = groups.length;

      groups.forEach((g, gi) => {
        const qty = groupQty(g);
        const amount = groupAmount(g);
        const isArea = (g.unit === 'm¬≤');
        const collapsed = !!g.collapsed;

        const div = document.createElement('div');
        div.className = 'group' + (collapsed ? ' collapsed' : '');
        div.dataset.gi = String(gi);

        div.innerHTML = `
          <div class="group-hd">
            <div class="left">
              <input class="mini" data-gi="${gi}" data-gk="name"
                value="${escapeHtml(g.name)}" placeholder="T√™n nh√≥m (VD: Tr·∫ßn)" />
              <select class="mini3" data-gi="${gi}" data-gk="unit">${unitOptions(g.unit)}</select>
              <input class="mini2" style="text-align:right" data-gi="${gi}" data-gk="unitPrice"
                value="${escapeHtml(g.unitPrice)}" placeholder="ƒê∆°n gi√°" />
            </div>
            <div class="right">
              <span class="pill">Kh·ªëi l∆∞·ª£ng: <b>${qty.toLocaleString('vi-VN',{maximumFractionDigits:3})} ${escapeHtml(g.unit)}</b></span>
              <span class="pill">Ti·ªÅn nh√≥m: <b>${fmtVND(amount)}</b></span>
              <button class="ghost" data-act="toggleGroup" data-gi="${gi}">${collapsed ? 'M·ªü' : 'Thu'}</button>
              <button class="primary" data-act="addLine" data-gi="${gi}">+ D√≤ng</button>
              <button class="danger" data-act="delGroup" data-gi="${gi}">X√≥a</button>
            </div>
          </div>

          <div class="group-body">
            <div style="padding:10px;border-bottom:1px solid rgba(2,132,199,.14)">
              <div class="field" style="margin:0">
                <label>Ghi ch√∫ nh√≥m (hi·ªÉn th·ªã tr√™n b·∫£ng thanh to√°n)</label>
                <input data-gi="${gi}" data-gk="groupNote"
                  value="${escapeHtml(g.groupNote)}" placeholder="VD: Tr·∫ßn ph√≤ng kh√°ch + b·∫øp..." />
              </div>
            </div>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th class="center" style="width:56px">#</th>
                    <th class="num" style="width:120px">${isArea?'D√†i':'S·ªë l∆∞·ª£ng'}</th>
                    <th class="num" style="width:120px">${isArea?'R·ªông':'‚Äî'}</th>
                    <th class="num" style="width:90px">H·ªá s·ªë</th>
                    <th style="min-width:220px">Ghi ch√∫ t·ª´ng d√≤ng</th>
                    <th class="num" style="width:140px">KQ d√≤ng</th>
                    <th class="center" style="width:90px">X√≥a</th>
                  </tr>
                </thead>
                <tbody>
                  ${(g.lines || []).map((L, li) => {
                    const len = parseNumber(L.len), wid = parseNumber(L.wid);
                    const fac = parseNumber(L.factor) || 1;
                    const res = isArea ? (len*wid*fac) : (len*fac);
                    return `
                      <tr>
                        <td class="center">${li+1}</td>
                        <td class="num">
                          <input style="text-align:right" data-gi="${gi}" data-li="${li}" data-lk="len"
                            value="${escapeHtml(L.len)}" placeholder="${isArea?'VD: 3,22':'VD: 8'}" />
                        </td>
                        <td class="num">
                          <input style="text-align:right" data-gi="${gi}" data-li="${li}" data-lk="wid"
                            value="${escapeHtml(L.wid)}" placeholder="${isArea?'VD: 4,3':'‚Äî'}" ${isArea?'':'disabled'} />
                        </td>
                        <td class="num">
                          <input style="text-align:right" data-gi="${gi}" data-li="${li}" data-lk="factor"
                            value="${escapeHtml((L.factor ?? 1))}" placeholder="1" />
                        </td>
                        <td>
                          <input data-gi="${gi}" data-li="${li}" data-lk="note"
                            value="${escapeHtml((L.note ?? '').toString())}"
                            placeholder="VD: Khu A / Ph√≤ng kh√°ch..." />
                        </td>
                        <td class="num"><b>${res.toLocaleString('vi-VN',{maximumFractionDigits:3})} ${escapeHtml(g.unit)}</b></td>
                        <td class="center">
                          <button class="danger" data-act="delLine" data-gi="${gi}" data-li="${li}">X√≥a</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;

        wrap.appendChild(div);
      });

      recalc();
      autoSave();
      restoreFocus(focusKey);
    }

    function recalc(){
      const total = groups.reduce((s,g)=> s + groupAmount(g), 0);
      const adv = parseNumber(document.getElementById('advance').value);
      const remain = total - adv;

      const m2 = totalM2All();
      document.getElementById('sumM2').textContent = m2.toLocaleString('vi-VN', { maximumFractionDigits: 3 }) + ' m¬≤';

      document.getElementById('sumTotal').textContent = fmtVND(total);
      document.getElementById('sumAdvance').textContent = fmtVND(adv);
      document.getElementById('sumRemain').textContent = fmtVND(remain);

      const st = document.getElementById('status');
      if (groups.length === 0) st.innerHTML = '<span style="color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu</span>';
      else if (remain > 0) st.innerHTML = `<span class="bad">C√≤n ph·∫£i tr·∫£</span>`;
      else if (remain === 0) st.innerHTML = `<span class="ok">ƒê√£ thanh to√°n ƒë·ªß</span>`;
      else st.innerHTML = `<span style="color:var(--warn)">Tr·∫£ d∆∞</span>`;

      const bar = document.getElementById('kpiBar');
      const hint = document.getElementById('kpiHint');
      const paid = Math.max(0, Math.min(1, total > 0 ? (adv / total) : 0));
      if (bar) bar.style.width = (paid * 100).toFixed(0) + '%';
      if (hint){
        if (total <= 0) hint.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
        else hint.textContent = `ƒê√£ t·∫°m ·ª©ng ~ ${(paid*100).toFixed(0)}%`;
      }
    }

    function save(){
      const payload = {
        groups,
        advance: document.getElementById('advance').value ?? '',
        invDate: document.getElementById('invDate').value ?? '',
        invCustomer: document.getElementById('invCustomer').value ?? '',
        invAddress: document.getElementById('invAddress').value ?? '',
        invContact: document.getElementById('invContact').value ?? '',
        bankName: document.getElementById('bankName').value ?? '',
        bankBranch: document.getElementById('bankBranch').value ?? '',
        bankAccountName: document.getElementById('bankAccountName').value ?? '',
        bankAccountNo: document.getElementById('bankAccountNo').value ?? '',
        globalNote: document.getElementById('globalNote').value ?? '',
        ts: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }
    function autoSave(){ save(); }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try{
        const p = JSON.parse(raw);
        groups = Array.isArray(p.groups) ? p.groups : [];
        document.getElementById('advance').value = p.advance ?? '';
        document.getElementById('invDate').value = p.invDate ?? '';
        document.getElementById('invCustomer').value = p.invCustomer ?? '';
        document.getElementById('invAddress').value = p.invAddress ?? '';
        document.getElementById('invContact').value = p.invContact ?? '';
        document.getElementById('bankName').value = p.bankName ?? '';
        document.getElementById('bankBranch').value = p.bankBranch ?? '';
        document.getElementById('bankAccountName').value = p.bankAccountName ?? '';
        document.getElementById('bankAccountNo').value = p.bankAccountNo ?? '';
        document.getElementById('globalNote').value = p.globalNote ?? '';
        return true;
      }catch(e){ console.error(e); return false; }
    }

    function normalizeGroups(gs){
      return (gs || []).map(g => ({
        name: (g.name ?? 'Nh√≥m').toString(),
        unit: (g.unit ?? 'm¬≤').toString().replace('m2','m¬≤'),
        unitPrice: (g.unitPrice ?? '').toString(),
        groupNote: (g.groupNote ?? '').toString(),
        collapsed: !!g.collapsed,
        lines: (g.lines && g.lines.length ? g.lines : [{len:'',wid:'',factor:1,note:''}]).map(L => ({
          len: (L.len ?? '').toString(),
          wid: (L.wid ?? '').toString(),
          factor: (L.factor ?? 1),
          note: (L.note ?? '').toString()
        }))
      }));
    }

    // ===== PROJECT FILE EXPORT/IMPORT =====
    const PROJECT_EXT = '.tcproj.json';

    function collectProjectPayload() {
      return {
        format: 'thachcao_project',
        version: 1,
        savedAt: new Date().toISOString(),
        data: {
          groups,
          advance: document.getElementById('advance').value ?? '',
          invDate: document.getElementById('invDate').value ?? '',
          invCustomer: document.getElementById('invCustomer').value ?? '',
          invAddress: document.getElementById('invAddress').value ?? '',
          invContact: document.getElementById('invContact').value ?? '',
          bankName: document.getElementById('bankName').value ?? '',
          bankBranch: document.getElementById('bankBranch').value ?? '',
          bankAccountName: document.getElementById('bankAccountName').value ?? '',
          bankAccountNo: document.getElementById('bankAccountNo').value ?? '',
          globalNote: document.getElementById('globalNote').value ?? '',
          ts: Date.now()
        }
      };
    }

    function applyProjectPayload(projectObj) {
      if (!projectObj || projectObj.format !== 'thachcao_project' || !projectObj.data) {
        throw new Error('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng d·ª± √°n th·∫°ch cao.');
      }
      const d = projectObj.data;

      document.getElementById('advance').value = d.advance ?? '';
      document.getElementById('invDate').value = d.invDate ?? '';
      document.getElementById('invCustomer').value = d.invCustomer ?? '';
      document.getElementById('invAddress').value = d.invAddress ?? '';
      document.getElementById('invContact').value = d.invContact ?? '';
      document.getElementById('bankName').value = d.bankName ?? '';
      document.getElementById('bankBranch').value = d.bankBranch ?? '';
      document.getElementById('bankAccountName').value = d.bankAccountName ?? '';
      document.getElementById('bankAccountNo').value = d.bankAccountNo ?? '';
      document.getElementById('globalNote').value = d.globalNote ?? '';

      groups = normalizeGroups(Array.isArray(d.groups) ? d.groups : []);
      render();
      save();
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== NEW FILENAME RULE =====
    function yyyymmddFromInvDate(){
      const raw = (document.getElementById('invDate')?.value || '').trim();
      const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m){
        const dd = String(m[1]).padStart(2,'0');
        const mm = String(m[2]).padStart(2,'0');
        const yy = String(m[3]);
        return `${yy}${mm}${dd}`;
      }
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${yy}${mm}${dd}`;
    }

    function sanitizeFilePart(s){
      return String(s ?? '')
        .replace(/[\\\/:*?"<>|]/g, '-')
        .replace(/[\u0000-\u001F]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function nextProjectIndexForDate(dateYYYYMMDD){
      const key = `tc_project_seq_${dateYYYYMMDD}`;
      const cur = Number(localStorage.getItem(key) || '0');
      const next = cur + 1;
      localStorage.setItem(key, String(next));
      return next;
    }

    function buildProjectFileBaseName(){
      const date = yyyymmddFromInvDate();

      let projectName = sanitizeFilePart(document.getElementById('invCustomer')?.value || '');
      let customerName = sanitizeFilePart(document.getElementById('invContact')?.value || '');

      if (!projectName){
        const idx = nextProjectIndexForDate(date);
        projectName = `C√¥ng tr√¨nh${idx}`;
      }

      return customerName
        ? `${date}_${projectName}_${customerName}`
        : `${date}_${projectName}`;
    }

    // ===== DEFAULT SAVE FOLDER (Chrome/Edge + HTTPS/localhost) =====
    let dirHandle = null;

    function fsSupported(){
      return !!(window.showDirectoryPicker && window.FileSystemHandle);
    }

    function idbOpen(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('tc_project_db', 1);
        req.onupgradeneeded = () => req.result.createObjectStore('kv');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbSet(key, val){
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('kv','readwrite');
        tx.objectStore('kv').put(val, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }
    async function idbGet(key){
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('kv','readonly');
        const req = tx.objectStore('kv').get(key);
        req.onsuccess = () => resolve(req.result ?? null);
        req.onerror = () => reject(tx.error);
      });
    }

    async function restoreDefaultFolder(){
      if (!fsSupported()) { updateSaveFolderHint(); return; }
      try{
        const h = await idbGet('default_dir');
        if (h) dirHandle = h;
      }catch{}
      updateSaveFolderHint();
    }

    function updateSaveFolderHint(){
      const el = document.getElementById('saveFolderHint');
      if (!el) return;
      if (dirHandle) el.innerHTML = `N∆°i l∆∞u: <b>ƒê√£ ch·ªçn</b>`;
      else el.innerHTML = `N∆°i l∆∞u: <b>Download</b>`;
    }

    async function pickDefaultFolder(){
      if (!fsSupported()){
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ch·ªçn th∆∞ m·ª•c l∆∞u m·∫∑c ƒë·ªãnh. D√πng Chrome/Edge v√† ch·∫°y HTTPS ho·∫∑c localhost.');
        return;
      }
      try{
        dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        await idbSet('default_dir', dirHandle);
        updateSaveFolderHint();
        toast('ƒê√£ ch·ªçn n∆°i l∆∞u m·∫∑c ƒë·ªãnh');
      }catch(err){
        console.error(err);
      }
    }

    async function saveTextToDefaultFolder(filename, text){
      if (!dirHandle) return false;
      try{
        const perm = await dirHandle.requestPermission({ mode:'readwrite' });
        if (perm !== 'granted') return false;

        const fileHandle = await dirHandle.getFileHandle(filename, { create:true });
        const writable = await fileHandle.createWritable();
        await writable.write(new Blob([text], {type:'application/json;charset=utf-8'}));
        await writable.close();
        return true;
      }catch(err){
        console.error(err);
        return false;
      }
    }

    async function exportProjectFile(withTimestamp=false) {
      const payload = collectProjectPayload();
      const json = JSON.stringify(payload, null, 2);

      const base = buildProjectFileBaseName();
      const ts = withTimestamp ? `-${Date.now()}` : '';
      const filename = `${base}${ts}${PROJECT_EXT}`;

      const saved = await saveTextToDefaultFolder(filename, json);
      if (saved){
        toast('ƒê√£ xu·∫•t file d·ª± √°n v√†o n∆°i l∆∞u m·∫∑c ƒë·ªãnh');
        return;
      }
      downloadTextFile(filename, json);
      toast('ƒê√£ xu·∫•t file d·ª± √°n');
    }

    async function importProjectFromFile(file) {
      const text = await file.text();
      let obj;
      try { obj = JSON.parse(text); }
      catch { throw new Error('File kh√¥ng ph·∫£i JSON h·ª£p l·ªá.'); }
      applyProjectPayload(obj);
    }

    // ===== Invoice HTML =====
    function buildInvoiceHTML(){
      const invDate = document.getElementById('invDate').value.trim();
      const invCustomer = document.getElementById('invCustomer').value.trim();
      const invAddress = document.getElementById('invAddress').value.trim();
      const invContact = document.getElementById('invContact').value.trim();

      const bankName = document.getElementById('bankName').value.trim();
      const bankBranch = document.getElementById('bankBranch').value.trim();
      const bankAccountName = document.getElementById('bankAccountName').value.trim();
      const bankAccountNo = document.getElementById('bankAccountNo').value.trim();

      const globalNote = document.getElementById('globalNote').value ?? '';

      const total = groups.reduce((s,g)=> s + groupAmount(g), 0);
      const adv = parseNumber(document.getElementById('advance').value);
      const remain = total - adv;

      const totalM2 = totalM2All();

      const fmtVNDHtml = (n) => {
        const v = Number(n) || 0;
        const cls = v < 0 ? 'neg' : '';
        return `<span class="${cls}">${fmtVND(v)}</span>`;
      };

      let groupIndex = 0;
      const detailRows = groups.flatMap((g) => {
        const isArea = (g.unit === 'm¬≤');
        const rows = [];

        groupIndex++;
        rows.push({
          stt: String(groupIndex),
          item: g.name || '(Ch∆∞a ƒë·∫∑t t√™n nh√≥m)',
          detail: (g.groupNote || ''),
          qty: groupQty(g),
          unit: g.unit,
          unitPrice: parseNumber(g.unitPrice),
          amount: groupAmount(g),
          isGroupHeader: true
        });

        let subIndex = 0;
        (g.lines || []).forEach((L) => {
          const len = parseNumber(L.len), wid = parseNumber(L.wid);
          const fac = parseNumber(L.factor) || 1;
          const lineQty = isArea ? (len*wid*fac) : (len*fac);

          const note = (L.note ?? '').toString().trim();
          const hasAny = lineQty !== 0 || note.length > 0;
          if (!hasAny) return;

          subIndex++;
          const sttLine = `${groupIndex}.${subIndex}`;

          const formula = isArea
            ? `${L.len || 0} √ó ${L.wid || 0} √ó ${fac}`
            : `${L.len || 0} √ó ${fac}`;

          rows.push({
            stt: sttLine,
            item: `‚Ü≥ D√≤ng ${subIndex}`,
            detail: `${formula}${note ? ' | Ghi ch√∫: ' + note : ''}`,
            qty: lineQty,
            unit: g.unit,
            unitPrice: '',
            amount: ''
          });
        });

        return rows;
      });

      const detailHTML = detailRows.map(r => {
        const fmtNum = (x, opt) => Number(x).toLocaleString('vi-VN', opt);
        const numHtml = (x, opt) => {
          const v = Number(x);
          const cls = (isFinite(v) && v < 0) ? 'neg' : '';
          return `<span class="${cls}">${fmtNum(v, opt)}</span>`;
        };

        const qtyStr = (r.qty === '' || r.qty === null || r.qty === undefined)
          ? ''
          : numHtml(r.qty, { maximumFractionDigits: 3 });

        const upStr = (r.unitPrice === '' || r.unitPrice === null || r.unitPrice === undefined)
          ? ''
          : numHtml(r.unitPrice, { maximumFractionDigits: 0 });

        const amtStr = (r.amount === '' || r.amount === null || r.amount === undefined)
          ? ''
          : numHtml(r.amount, { maximumFractionDigits: 0 });

        const rowStyle = r.isGroupHeader ? 'style="font-weight:800;background:#fbfdff"' : '';
        const detail = escapeHtml(r.detail || '');

        return `
          <tr ${rowStyle}>
            <td class="inv-center">${escapeHtml(r.stt)}</td>
            <td>${escapeHtml(r.item)}</td>
            <td class="inv-muted">${detail}</td>
            <td class="inv-right">${qtyStr}</td>
            <td class="inv-center">${escapeHtml(r.unit || '')}</td>
            <td class="inv-right">${upStr}</td>
            <td class="inv-right">${amtStr}</td>
          </tr>
        `;
      }).join('');

      const statusText = remain > 0 ? 'C√≤n ph·∫£i thanh to√°n' : (remain === 0 ? 'ƒê√£ thanh to√°n ƒë·ªß' : 'ƒê√£ tr·∫£ d∆∞');

      document.getElementById('invMetaSmall').textContent =
        `‚Ä¢ T·ªïng m¬≤: ${totalM2.toLocaleString('vi-VN',{maximumFractionDigits:3})} m¬≤ ‚Ä¢ T·ªïng: ${fmtVND(total)} ‚Ä¢ T·∫°m ·ª©ng: ${fmtVND(adv)} ‚Ä¢ C√≤n l·∫°i: ${fmtVND(remain)}`;

      const bankHtml = (bankName || bankAccountNo || bankAccountName || bankBranch) ? `
        <div class="inv-box" style="margin-top:10px">
          <div><b>Ng√¢n h√†ng:</b> ${escapeHtml(bankName || '‚Äî')}</div>
          <div><b>Chi nh√°nh:</b> ${escapeHtml(bankBranch || '‚Äî')}</div>
          <div><b>Ch·ªß t√†i kho·∫£n:</b> ${escapeHtml(bankAccountName || '‚Äî')}</div>
          <div><b>S·ªë t√†i kho·∫£n:</b> ${escapeHtml(bankAccountNo || '‚Äî')}</div>
        </div>
      ` : '';

      return `
        <div class="inv-top">
          <div class="inv-meta">
            <div><b>Ng√†y:</b> ${escapeHtml(invDate || '‚Äî')}</div>
          </div>
        </div>

        <div class="inv-title">B·∫¢NG THANH TO√ÅN</div>
        <div class="inv-sub">T·ªïng h·ª£p kh·ªëi l∆∞·ª£ng & gi√° tr·ªã</div>

        <div class="inv-box">
          <div><b>Kh√°ch h√†ng / C√¥ng tr√¨nh:</b> ${escapeHtml(invCustomer || '‚Äî')}</div>
          <div><b>ƒê·ªãa ch·ªâ c√¥ng tr√¨nh:</b> ${escapeHtml(invAddress || '‚Äî')}</div>
          <div><b>Li√™n h·ªá:</b> ${escapeHtml(invContact || '‚Äî')}</div>
          <div><b>Ghi ch√∫ chung:</b> ${escapeHtml((globalNote || '').trim() || '‚Äî')}</div>
        </div>

        ${bankHtml}

        <table class="inv-table">
          <thead>
            <tr>
              <th style="width:56px" class="inv-center">STT</th>
              <th style="width:170px">H·∫°ng m·ª•c</th>
              <th>Chi ti·∫øt / Ghi ch√∫</th>
              <th style="width:110px" class="inv-right">Kh·ªëi l∆∞·ª£ng</th>
              <th style="width:70px" class="inv-center">ƒêVT</th>
              <th style="width:120px" class="inv-right">ƒê∆°n gi√°</th>
              <th style="width:130px" class="inv-right">Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody>
            ${detailHTML || `<tr><td colspan="7" class="inv-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`}
          </tbody>
        </table>

        <div class="inv-total">
          <div class="row"><span>T·ªïng m¬≤ (c√°c nh√≥m m¬≤)</span><b>${totalM2.toLocaleString('vi-VN',{maximumFractionDigits:3})} m¬≤</b></div>
          <div class="row"><span>T·ªïng c·ªông</span><b>${fmtVNDHtml(total)}</b></div>
          <div class="row"><span>T·∫°m ·ª©ng</span><b>${fmtVNDHtml(adv)}</b></div>
          <div class="row grand"><span><b>C√≤n l·∫°i ph·∫£i thanh to√°n</b></span><b>${fmtVNDHtml(remain)}</b></div>
          <div class="row"><span>Tr·∫°ng th√°i</span><b>${escapeHtml(statusText)}</b></div>
        </div>

        <div class="print-note">In/PDF: Ctrl+P (Chrome/Edge) ‚Üí Destination: Save as PDF</div>
      `;
    }

    function lockBodyScroll(lock){
      document.body.style.overflow = lock ? 'hidden' : '';
      document.body.style.touchAction = lock ? 'none' : '';
    }

    function openInvoice(){
      const modal = document.getElementById('invoiceModal');
      const content = document.getElementById('invoiceContent');
      content.innerHTML = buildInvoiceHTML();
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll(true);
      content.scrollTop = 0;
    }

    function closeInvoice(){
      const modal = document.getElementById('invoiceModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      lockBodyScroll(false);
    }

    async function renderInvoiceFullToCanvas(scale){
      const src = document.getElementById('invoiceContent');
      if (!src) throw new Error('Kh√¥ng t√¨m th·∫•y n·ªôi dung b·∫£ng thanh to√°n.');

      const stage = document.createElement('div');
      stage.style.position = 'fixed';
      stage.style.left = '-100000px';
      stage.style.top = '0';
      stage.style.background = '#ffffff';
      stage.style.padding = '24px';
      stage.style.width = '980px';
      stage.style.boxSizing = 'border-box';

      const frame = document.createElement('div');
      frame.style.background = '#fff';
      frame.style.border = '1px solid rgba(2,132,199,.25)';
      frame.style.borderRadius = '18px';
      frame.style.overflow = 'hidden';
      frame.style.boxShadow = '0 18px 60px rgba(2,132,199,.12)';
      frame.style.padding = '18px';
      frame.style.boxSizing = 'border-box';

      const clone = src.cloneNode(true);
      clone.style.height = 'auto';
      clone.style.maxHeight = 'none';
      clone.style.overflow = 'visible';

      frame.appendChild(clone);
      stage.appendChild(frame);
      document.body.appendChild(stage);

      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      const canvas = await html2canvas(stage, {
        backgroundColor: '#ffffff',
        scale,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: stage.scrollWidth,
        windowHeight: stage.scrollHeight,
      });

      stage.remove();
      return canvas;
    }

    async function copyInvoiceAsImage(){
      const scale = Math.min(2.0, (window.devicePixelRatio || 1) * 1.6);

      try{
        if (!window.html2canvas) throw new Error('Ch∆∞a t·∫£i ƒë∆∞·ª£c html2canvas (CDN).');

        const canvas = await renderInvoiceFullToCanvas(scale);
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png', 1));
        if (!blob) throw new Error('Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh.');

        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          toast('ƒê√£ copy ·∫£nh FULL v√†o clipboard');
          return;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bang-thanh-toan-full-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast('ƒê√£ t·∫£i ·∫£nh FULL v·ªÅ m√°y');
      }catch(err){
        console.error(err);
        alert('Kh√¥ng copy ƒë∆∞·ª£c ·∫£nh. L∆∞u √Ω: c·∫ßn HTTPS v√† ph·∫£i t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán CDN html2canvas.');
      }
    }

    async function copyInvoiceForMobile(){
      const scale = Math.min(2.0, (window.devicePixelRatio || 1) * 1.6);

      try{
        if (!window.html2canvas) throw new Error('Ch∆∞a t·∫£i ƒë∆∞·ª£c html2canvas (CDN).');

        const canvas = await renderInvoiceFullToCanvas(scale);
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png', 1));
        if (!blob) throw new Error('Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh.');

        const file = new File([blob], `bang-thanh-toan-full-${Date.now()}.png`, { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'B·∫£ng thanh to√°n (FULL)',
            text: '·∫¢nh b·∫£ng thanh to√°n FULL chi·ªÅu d√†i',
            files: [file],
          });
          return;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        a.remove();

        alert('ƒê√£ m·ªü ·∫£nh FULL ·ªü tab m·ªõi. B·∫°n gi·ªØ ·∫£nh v√† ch·ªçn ‚ÄúL∆∞u h√¨nh ·∫£nh‚Äù.');
        setTimeout(() => URL.revokeObjectURL(url), 15000);

      }catch(err){
        console.error(err);
        alert('Kh√¥ng t·∫°o/copy ƒë∆∞·ª£c ·∫£nh. L∆∞u √Ω: c·∫ßn HTTPS v√† ph·∫£i t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán html2canvas (CDN) ho·∫∑c nh√∫ng html2canvas local.');
      }
    }

    function buildInvoiceImageFileName(){
      const date = yyyymmddFromInvDate();
      const proj = sanitizeFilePart(document.getElementById('invCustomer')?.value || 'BangThanhToan');
      const contact = sanitizeFilePart(document.getElementById('invContact')?.value || '');
      const base = contact ? `${date}_${proj}_${contact}` : `${date}_${proj}`;
      return `${base}_BangThanhToan.png`;
    }

    async function downloadInvoiceAsImage(){
      const scale = Math.min(2.2, (window.devicePixelRatio || 1) * 1.8);
      try{
        if (!window.html2canvas) throw new Error('Ch∆∞a t·∫£i ƒë∆∞·ª£c html2canvas (CDN).');

        const canvas = await renderInvoiceFullToCanvas(scale);
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png', 1));
        if (!blob) throw new Error('Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh.');

        const filename = buildInvoiceImageFileName();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 1500);
        toast('ƒê√£ xu·∫•t b·∫£ng thanh to√°n ra file PNG');
      }catch(err){
        console.error(err);
        alert('Kh√¥ng xu·∫•t ƒë∆∞·ª£c ·∫£nh. L∆∞u √Ω: c·∫ßn t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán html2canvas (CDN) v√† trang n√™n ch·∫°y HTTPS/localhost ƒë·ªÉ ·ªïn ƒë·ªãnh.');
      }
    }

    function flashGroup(gi){
      const el = document.querySelector(`.group[data-gi="${gi}"]`);
      if (!el) return;
      el.style.boxShadow = '0 0 0 6px rgba(56,189,248,.28), 0 18px 60px rgba(2,132,199,.18)';
      setTimeout(() => el.style.boxShadow = '', 950);
    }

    // ===== Events =====
    document.addEventListener('input', (e) => {
      const t = e.target;

      if (t.matches('[data-gi][data-gk]')) {
        const gi = Number(t.dataset.gi);
        const gk = t.dataset.gk;
        if (!groups[gi]) return;
        groups[gi][gk] = t.value;
        scheduleRender();
        return;
      }

      if (t.matches('[data-gi][data-li][data-lk]')) {
        const gi = Number(t.dataset.gi);
        const li = Number(t.dataset.li);
        const lk = t.dataset.lk;
        if (!groups[gi] || !groups[gi].lines[li]) return;
        groups[gi].lines[li][lk] = t.value;
        scheduleRender();
        return;
      }

      if (t.id === 'advance' || t.id === 'invDate' || t.id === 'invCustomer' || t.id === 'invAddress' ||
          t.id === 'invContact' || t.id === 'globalNote' ||
          t.id === 'bankName' || t.id === 'bankBranch' || t.id === 'bankAccountName' || t.id === 'bankAccountNo') {
        recalc();
        autoSave();
      }
    });

    document.addEventListener('change', (e) => {
      const t = e.target;
      if (t.matches('select[data-gi][data-gk="unit"]')) {
        const gi = Number(t.dataset.gi);
        if (!groups[gi]) return;
        groups[gi].unit = t.value;
        render();
      }

      if (t.id === 'projectFileInput') {
        const file = t.files && t.files[0];
        if (!file) return;
        importProjectFromFile(file)
          .then(() => toast('ƒê√£ m·ªü file d·ª± √°n'))
          .catch(err => alert('Kh√¥ng m·ªü ƒë∆∞·ª£c file: ' + (err.message || err)));
        t.value = '';
      }
    });

    document.addEventListener('click', (e) => {
      const t = e.target;

      if (t.id === 'addGroup') { groups.push(defaultGroup()); render(); toast('ƒê√£ th√™m nh√≥m'); return; }
      if (t.id === 'saveBtn') { save(); toast('ƒê√£ l∆∞u'); return; }
      if (t.id === 'loadBtn') { load(); groups = normalizeGroups(groups); render(); toast('ƒê√£ t·∫£i'); return; }
      if (t.id === 'clearBtn') {
        if (!confirm('X√≥a t·∫•t c·∫£ nh√≥m?')) return;
        groups = [];
        document.getElementById('advance').value = '';
        render();
        toast('ƒê√£ x√≥a t·∫•t c·∫£');
        return;
      }

      if (t.id === 'btnExportProject') { exportProjectFile(false); return; }
      if (t.id === 'btnExportBackup') { exportProjectFile(true); return; }
      if (t.id === 'btnImportProject') { document.getElementById('projectFileInput').click(); return; }
      if (t.id === 'btnPickSaveFolder') { pickDefaultFolder(); return; }

      if (t.id === 'btnNewProject') {
        if (!confirm('T·∫°o d·ª± √°n m·ªõi? (N√™n Xu·∫•t file tr∆∞·ªõc khi x√≥a)')) return;
        groups = [];
        document.getElementById('advance').value = '';
        document.getElementById('invDate').value = todayVN();
        document.getElementById('invCustomer').value = '';
        document.getElementById('invAddress').value = '';
        document.getElementById('invContact').value = '';
        document.getElementById('bankName').value = '';
        document.getElementById('bankBranch').value = '';
        document.getElementById('bankAccountName').value = '';
        document.getElementById('bankAccountNo').value = '';
        document.getElementById('globalNote').value = '';
        render();
        save();
        toast('ƒê√£ t·∫°o d·ª± √°n m·ªõi');
        return;
      }

      if (t.id === 'btnExpandAll'){
        groups.forEach(g => g.collapsed = false);
        render();
        toast('ƒê√£ m·ªü h·∫øt nh√≥m');
        return;
      }
      if (t.id === 'btnCollapseAll'){
        groups.forEach(g => g.collapsed = true);
        render();
        toast('ƒê√£ thu g·ªçn h·∫øt nh√≥m');
        return;
      }

      if (t.dataset.act === 'toggleGroup'){
        const gi = Number(t.dataset.gi);
        if (!groups[gi]) return;
        groups[gi].collapsed = !groups[gi].collapsed;
        render();
        return;
      }

      if (t.dataset.act === 'addLine') {
        const gi = Number(t.dataset.gi);
        if (!groups[gi]) return;
        groups[gi].lines.push({len:'',wid:'',factor:1,note:''});
        render();
        return;
      }
      if (t.dataset.act === 'delGroup') {
        const gi = Number(t.dataset.gi);
        groups.splice(gi, 1);
        render();
        toast('ƒê√£ x√≥a nh√≥m');
        return;
      }
      if (t.dataset.act === 'delLine') {
        const gi = Number(t.dataset.gi);
        const li = Number(t.dataset.li);
        if (!groups[gi]) return;
        groups[gi].lines.splice(li, 1);
        if (groups[gi].lines.length === 0) groups[gi].lines.push({len:'',wid:'',factor:1,note:''});
        render();
        return;
      }

      if (t.id === 'invoiceBtn') { openInvoice(); return; }
      if (t.id === 'copyImgBtn' || t.id === 'copyImgBtn2') { copyInvoiceAsImage(); return; }
      if (t.id === 'downloadImgBtn' || t.id === 'downloadImgBtn2') { downloadInvoiceAsImage(); return; }
      if (t.id === 'copyMobileBtn' || t.id === 'copyMobileBtn2') { copyInvoiceForMobile(); return; }
      if (t.id === 'closeInvoice' || t.id === 'closeInvoice2') { closeInvoice(); return; }
      if (t.id === 'printBtn' || t.id === 'printBtn2') { window.print(); return; }

      if (t.id === 'btnTop'){ window.scrollTo({top:0, behavior:'smooth'}); return; }

      // ‚úÖ NEW: toggle mobile mode buttons
      if (t.id === 'toggleMobileBtn' || t.id === 'toggleMobileFab') { toggleMobileForced(); return; }
    });

    document.getElementById('invoiceModal').addEventListener('click', (e) => {
      if (e.target.id === 'invoiceModal') closeInvoice();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeInvoice();
    });

    document.getElementById('quickSearch').addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      const q = (e.target.value || '').trim().toLowerCase();
      if (!q) return;
      const gi = groups.findIndex(g => (g.name || '').toString().toLowerCase().includes(q));
      if (gi < 0) { toast('Kh√¥ng t√¨m th·∫•y nh√≥m'); return; }
      groups[gi].collapsed = false;
      render();
      const el = document.querySelector(`.group[data-gi="${gi}"]`);
      if (el){
        el.scrollIntoView({behavior:'smooth', block:'start'});
        setTimeout(() => flashGroup(gi), 250);
      }
    });

    (function init(){
      const ok = load();
      if (!ok || groups.length === 0){
        groups = [
          { name:'Tr·∫ßn', unit:'m¬≤', unitPrice:'40000', groupNote:'Tr·∫ßn ph√≤ng kh√°ch + b·∫øp', collapsed:false, lines:[
            {len:'3,22', wid:'4,3', factor:1, note:'Khu A'},
            {len:'6,7',  wid:'4,2', factor:1, note:'Khu B'},
          ]},
          { name:'V√°ch', unit:'m¬≤', unitPrice:'70000', groupNote:'V√°ch 2 m·∫∑t', collapsed:false, lines:[
            {len:'5', wid:'1,4', factor:2, note:'2 v√°ch h√¥ng'},
          ]},
          { name:'L·ªó th√¥ng tr·∫ßn', unit:'l·ªó', unitPrice:'50000', groupNote:'Khoan l·ªó + x·ª≠ l√Ω vi·ªÅn', collapsed:false, lines:[
            {len:'2', wid:'', factor:1, note:'2 l·ªó'},
          ]},
        ];
      }

      if (!document.getElementById('invDate').value.trim()) {
        document.getElementById('invDate').value = todayVN();
      }

      groups = normalizeGroups(groups);
      restoreDefaultFolder();
      render();

      // ‚úÖ restore mobile mode last state
      restoreMobileForced();
    })();
  </script>
</body>
</html>
